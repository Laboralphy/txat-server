var fs = require('fs');
var crypto = require('crypto');
var Q = require('q');

var PASS_STORAGE = 'pass.storage';


try {
	fs.statSync(PASS_STORAGE);
} catch (e) {
	fs.mkdirSync(PASS_STORAGE);
}


function checkUserPassword(sUser, sPass) {
	var sFile = PASS_STORAGE + '/' + sUser;
	var qStat = Q.nbind(fs.stat);
	var qReadFile = Q.nbind(fs.readFile);
	return qStat(sFile).then(function(data) {
		return qReadFile(sFile);
	}).then(function(data) {
		var deferred = Q.defer();
		var hash = '';
		var r = data.toString().match(/[0-9A-FA-f ]+/);
		sPassSha256 = crypto.createHash('sha256').update(sPass).digest('hex');
		if (r) {
			hash = r[0];
		} else {
		}
		if (hash === sPassSha256) {
			deferred.resolve();
		} else {
			deferred.reject(new Error('invalid login/password : ', hash, 'vs', sPassSha256));
		}
		return deferred.promise;
	}, function(err) {
		console.log(err);
	});
}

function defineUserPassword(sUser, sPass) {
	var hash = crypto.createHash('sha256').update(sPass).digest('hex');
	fs.writeFile(PASS_STORAGE + '/' + sUser, hash);
}



module.exports = {
	check: checkUserPassword,
	change: defineUserPassword
}
