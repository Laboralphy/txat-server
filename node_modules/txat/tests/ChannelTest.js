var Channel = require('../Channel.js');
var user = require('../User.js');

test('basic', function(assert) {
	var c = new Channel();
	assert.ok(!!c, 'channel instantiated');
	assert.deepEqual(c.aUsers, [], 'users is an empty array');
	assert.ok(!!c.oWhiteList, 'whitelist is an empty object');
	assert.ok(!!c.oBlackList, 'blacklist is an empty object');
	assert.equal(c.getUserCount(), 0, 'no user in empty channel');
});

test('white list', function(assert) {
	var c = new Channel();
	var nDelay = 3 * 24 * 3600 * 1000;
	var nNow = Date.now();
	assert.ok(c.isPublic(), 'channel has no white list yet');
	assert.ok(c.isUserAccessGranted('foo'), 'foo is allowed to public channel');
	assert.ok(c.isUserAccessGranted('bar'), 'bar is allowed to public channel');
	c.addUserToWhiteList('foo', nNow + nDelay);
	assert.deepEqual(c.oWhiteList.oList, {foo: nNow + nDelay}, 'user foo registred in white list');
	assert.ok(!c.isPublic(), 'channel has no white list yet');
	assert.ok(c.isUserAccessGranted('foo'), 'foo is allowed to private channel');
	assert.ok(!c.isUserAccessGranted('bar'), 'bar is no more allowed to private channel');
});

var User = function() {};
User.prototype.id = 0;
User.prototype.sName = '';
User.prototype.getName = function() {
		return this.sName;
};
User.prototype.grantPowers = function() {};
User.prototype.stripPowers = function() {};


function createUser(id, name) {
	var u = new User();
	u.id = id;
	u.sName = name;
	return u;
}

test('adding user', function(assert) {
	var c = new Channel();
	var u = createUser(10, 'foo');
	assert.ok(u, 'user instanciated');
	assert.equal(u.sName, 'foo', 'user mock checking name');
	assert.equal(u.id, 10, 'user mock checking name');
	c.addUser(u);
	
	assert.equal(c.getUserCount(), 1, 'one user');
	var u1 = createUser(11, 'bar');
	c.addUser(u1);
	assert.equal(c.getUserCount(), 2, 'two users');
	assert.equal(c.aUsers[0], 10, 'user 0 is foo');
	assert.equal(c.aUsers[1], 11, 'user 1 is foo');
	c.removeUser(u);
	assert.equal(c.aUsers[0], 11, 'user 0 is bar now');
	assert.equal(c.getUserCount(), 1, 'one user');
	c.removeUser(u1);
	assert.equal(c.getUserCount(), 0, 'no more user');
	c.addUser(u);
	var bException = false;
	try {
		c.addUser(u);
	} catch (e) {
		bException = true;
	}
	assert.ok(bException, 'error has occured when adding the same user twice');
});
